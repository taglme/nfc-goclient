# Taglme Desktop Golang SDK

[![CI](https://github.com/taglme/nfc-goclient/actions/workflows/ci.yml/badge.svg)](https://github.com/taglme/nfc-goclient/actions/workflows/ci.yml)
[![codecov](https://codecov.io/gh/taglme/nfc-goclient/branch/master/graph/badge.svg)](https://codecov.io/gh/taglme/nfc-goclient)
[![go.dev reference](https://img.shields.io/badge/go.dev-reference-007d9c?logo=go&logoColor=white&style=flat)](https://pkg.go.dev/github.com/taglme/nfc-goclient)
[![release](https://badgen.net/github/tag/taglme/nfc-goclient)](https://github.com/taglme/nfc-goclient/releases)

Official open-source Golang SDK library for [Taglme Desktop](https://github.com/taglme/desktop).
Quick and efficient way to connect applications with NFC REST API server.

## Reference Documentation

This SDK is intended to use in conjunction with Taglme Desktop REST API server. It is a thin API wrapper.
The main goal of the SDK is to handle requests complexity by hiding unnecessary details.

* [REST API specification](https://app.swaggerhub.com/apis-docs/Qwelp/nfcd/0.5) - this is full REST API specification in Swagger (OpenAPI) format. 
* [SDK API Reference](https://pkg.go.dev/github.com/taglme/nfc-goclient) - docs hosted by pkg.go.dev

### Overview of SDK's Packages

SDK consist of several packages

* client - core package with services. Services are used for communication with server API.
* models - basic types and structs 
* ndefconv - ndef format conversion operations

Overview of API resources

* Adapter - represents a NFC reader. 
* Tag - represents NFC tag. 
* Job - represents a set of operations (steps) that should be performed with tag (read, write, format etc). 
Jobs are added to adapter queue and start execution as soon as tag discovered by adapter.
* JobRun  - represents the result of job execution.
* Event - represents the event generated by the server. 
Events are sent by server through web socket connection. Client should listen for event messages in order to be notified when job execution if finished.

## Opening Issues

If you encounter a bug with the SDK for Go we would like to hear about it.
Search the [existing issues](https://github.com/taglme/nfc-goclient/issues) and see
if others are also experiencing the issue before opening a new issue. Please
include the version of SDK for Go, Go language, and OS you’re using. Please
also include reproduction case when appropriate.

The GitHub issues are intended for bug reports and feature requests. For help
and questions with using SDK for GO please make use of the resources listed
in the Reference Documentation section.
Keeping the list of open issues lean will help us respond in a timely manner.

### Installation

``` go get github.com/taglme/nfc-goclient ```

### Dependencies
This SDK uses Go modules. The metadata of the SDK's dependencies can be found in go.mod.

### Go Modules

If you are using Go modules, your `go get` will default to the latest tagged
release version of the SDK. To get a specific release version of the SDK use
`@<tag>` in your `go get` command.

	go get github.com/taglme/nfc-goclient@v1.1

Starting from v2.0.0 the SDK uses `X-App-Key` request authentication headers (legacy `Authorization: Bearer` is removed).

	go get github.com/taglme/nfc-goclient@v2.0.0

To get the latest SDK repository change use `@latest`.

	go get github.com/taglme/nfc-goclient@latest
    
### Usage

Extended examples in /cmd folder

### Authentication

All authenticated API requests use headers:

- `X-App-Key` (required)
- `X-User-Token` (optional)

Notes:
- `X-App-Key` is a thin signed JWT that identifies the client application (it no longer carries host scopes).
- `X-User-Token` is a short-lived signed JWT that contains a full `license` payload (same schema as `desktop.lic`).
- `GET /licenses/access` returns the active host access derived from the highest-priority license source for the request (header token > service token > offline license).

```Go
import "github.com/taglme/nfc-goclient/pkg/client"

//Create new API client
baseURL := "http://127.0.0.1:3011" // API server base URL
locale := "en" // preferred locale for messages from API server

// X-App-Key is required (signed JWT EdDSA generated by your tooling)
xAppKey := "<paste-x-app-key>"

// X-User-Token is optional
xUserToken := ""

c := client.NewWithOptions(client.Options{
	BaseURL: baseURL,
	Locale: locale,
	XAppKey: xAppKey,
	XUserToken: xUserToken,
})

// Request list of adapters
adapters, err := c.Adapters.GetAll()
// Get ID of the first adapter in list
adapterID:=adapters[0].AdapterID 

//Compose job with transmit bytes operation
opTransmit := models.JobStep{
		Command: models.CommandTransmitTag,
		Params: models.TransmitTagParams{
			TxBytes: []byte{0x60},
		},
	}
newJob := models.NewJob{
		JobName:     "Transmit tag",
		Repeat:      1,
		ExpireAfter: 60,
		Steps: []models.JobStepResource{
			opTransmit.ToResource(),
		},
	}

//Compose job with write NDEF url message operation
ndefMessage := []ndefconv.NdefRecord{
		ndefconv.NdefRecord{
			Type: ndefconv.NdefRecordPayloadTypeUrl,
			Data: ndefconv.NdefRecordPayloadUrl{
				Url: "https://tagl.me",
			},
		},
	}
opWrite := models.JobStep{
		Command: models.CommandWriteNdef,
		Params: models.WriteNdefParams{
			Message: ndefMessage,
		},
	}
newJob := models.NewJob{
		JobName:     "Write NDEF message",
		Repeat:      1,
		ExpireAfter: 60,
		Steps: []models.JobStepResource{
			opWrite.ToResource(),
		},
	}

// Add job to adapter queue
job, err:= c.Jobs.Add(adapterID, newJob)

// Initialize the  WS connection
err := c.Ws.Connect()
defer c.Ws.Disconnect()

eHandler := func(e models.Event) {
    // handle the received event
switch e.Name {
    case models.EventNameJobFinished:
		fmt.Println("[Job finished event]")
    case models.EventNameTagDiscovery:
		fmt.Println("[Tag discovered event]")    
        
    }
}

//Subscribe for server events
c.Ws.OnEvent(eHandler)

```


### Commands and Tools

Make could be used to execute some tasks
- `build` – build package
- `lint` – run linter
- `test` – run tests
- `deps` – manage dependencies

[CLI tool](https://github.com/taglme/nfc-cli) - fully functional CLI for API server based on this SDK.

### License
This SDK is distributed under the MIT license
